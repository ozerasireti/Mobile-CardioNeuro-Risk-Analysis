<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZGL BioSignal Analyzer v5.0</title>

<style>
body{
    margin:0;
    font-family:Segoe UI;
    background:#0f172a;
    color:white;
}
header{
    text-align:center;
    padding:40px;
    background:linear-gradient(135deg,#1e3a8a,#2563eb);
}
.container{
    max-width:1000px;
    margin:30px auto;
    padding:20px;
}
.card{
    background:#1e293b;
    padding:25px;
    border-radius:12px;
    margin-bottom:20px;
}
button{
    padding:12px 25px;
    border:none;
    border-radius:30px;
    background:#2563eb;
    color:white;
    cursor:pointer;
    margin-top:10px;
}
input{
    margin-top:10px;
    padding:8px;
}
#report{
    margin-top:20px;
    background:#0f172a;
    padding:20px;
    border-radius:10px;
    white-space:pre-line;
}
</style>
</head>

<body>

<header>
<h1>ZGL BioSignal Analyzer v5.0</h1>
<p>Kalibrasyonlu EKG Analiz Sistemi</p>
</header>

<div class="container">

<div class="card">
<h2>1️⃣ EKG Görseli Yükle</h2>
<input type="file" id="imageUpload" accept="image/*">
</div>

<div class="card">
<h2>2️⃣ Kalibrasyon</h2>
<label>1 Büyük Kare Kaç Piksel?</label><br>
<input type="number" id="calibration" placeholder="Örn: 20">
</div>

<div class="card">
<button onclick="analyzeImage()">Analizi Başlat</button>
<canvas id="canvas" style="display:none;"></canvas>
<div id="report"></div>
</div>

</div>

<footer style="text-align:center;padding:20px;">
Hazırlayan: Muhammed Ekrem Özer • 9-C
</footer>

<script>

let uploadedImage = new Image();

document.getElementById("imageUpload").addEventListener("change", function(event){
    const reader = new FileReader();
    reader.onload = function(){
        uploadedImage.src = reader.result;
    }
    reader.readAsDataURL(event.target.files[0]);
});

function analyzeImage(){

    const bigSquarePx = parseFloat(document.getElementById("calibration").value);

    if(!bigSquarePx || bigSquarePx <= 0){
        alert("Kalibrasyon değeri giriniz.");
        return;
    }

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = uploadedImage.width;
    canvas.height = uploadedImage.height;
    ctx.drawImage(uploadedImage,0,0);

    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const data = imageData.data;

    let waveform = [];

    for(let x=0; x<canvas.width; x++){
        let sum = 0;
        for(let y=0; y<canvas.height; y++){
            let i = (y*canvas.width + x)*4;
            let gray = (data[i]+data[i+1]+data[i+2])/3;
            sum += gray;
        }
        waveform.push(255-(sum/canvas.height));
    }

    let peaks=[];
    let minDistance = bigSquarePx * 2; // minimum 2 büyük kare arası

    for(let i=2;i<waveform.length-2;i++){
        if(waveform[i]>waveform[i-1] &&
           waveform[i]>waveform[i+1] &&
           waveform[i]>40){

           if(peaks.length===0 || i - peaks[peaks.length-1] > minDistance){
               peaks.push(i);
           }
        }
    }

    if(peaks.length<2){
        document.getElementById("report").innerText=
        "Yeterli R tepesi bulunamadı.";
        return;
    }

    let intervals=[];
    for(let i=1;i<peaks.length;i++){
        intervals.push(peaks[i]-peaks[i-1]);
    }

    let avgPx = intervals.reduce((a,b)=>a+b)/intervals.length;

    // 1 büyük kare = 0.20 saniye
    let secondsPerPixel = 0.20 / bigSquarePx;

    let rrSeconds = avgPx * secondsPerPixel;
    let bpm = 60 / rrSeconds;

    if(bpm > 220 || bpm < 30){
        document.getElementById("report").innerText=
        "Hesaplama hatası: Kalibrasyon veya görüntü uygun değil.";
        return;
    }

    let variance = intervals.reduce((s,v)=>s+Math.pow(v-avgPx,2),0)/intervals.length;
    let hrv = Math.sqrt(variance) * secondsPerPixel * 1000; // ms

    let rapor =
`---- ANALİZ RAPORU ----

Toplam R-Peak: ${peaks.length}
Ortalama R-R Süresi: ${rrSeconds.toFixed(3)} saniye
BPM: ${bpm.toFixed(1)}
HRV: ${hrv.toFixed(2)} ms

Yorum:
BPM 60-100 aralığında ise normal kabul edilir.
HRV değeri otonom sinir sistemi varyasyonunu gösterir.

Not:
Bu sistem görsel kalibrasyon temellidir ve klinik teşhis yerine geçmez.`;

    document.getElementById("report").innerText = rapor;
}

</script>

</body>
</html>
